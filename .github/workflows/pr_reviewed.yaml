name: PR Review Notification

on:
  pull_request_review:
    types: [submitted]

jobs:
  notify-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version-file: "pyproject.toml"
      - uses: astral-sh/setup-uv@v7
      - name: run notification
        shell: bash
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REVIEWER_NAME: ${{ github.event.review.user.login }}
          REVIEW_STATE: ${{ github.event.review.state }}
          TEST_CHANNEL_ID: ${{ secrets.TEST_CHANNEL_ID }}
          client_id: ${{ secrets.CLIENT_ID }}
          client_secret: ${{ secrets.CLIENT_SECRET }}
          works_client_id: ${{ secrets.WORKS_CLIENT_ID }}
          works_client_secret: ${{ secrets.WORKS_CLIENT_SECRET }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}
          private_key_path: ${{ secrets.PRIVATE_KEY_PATH }}
          bot_secret: ${{ secrets.BOT_SECRET }}
          PYTHON_SCRIPT: |
            import asyncio, os
            from bot.services.core.post_payload import async_post_message

            state = os.getenv("REVIEW_STATE").upper()
            message = (
              f"üìù [PR REVIEW SUBMITTED]\n"
              f"Ï†úÎ™©: {os.getenv('PR_TITLE')}\n"
              f"Î¶¨Î∑∞Ïñ¥: {os.getenv('REVIEWER_NAME')} ({state})\n"
              f"ÎßÅÌÅ¨: {os.getenv('PR_URL')}"
            )
            asyncio.run(async_post_message(message, os.getenv("TEST_CHANNEL_ID")))
        run: |
          uv sync --locked
          uv run python -c "$PYTHON_SCRIPT"
