name: Pull Request Created Event

on:
  pull_request:
    types: [opened, reopened, review_requested, closed]

jobs:
  pull_request_event:
    name: python
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version-file: "pyproject.toml"
      - uses: astral-sh/setup-uv@v7
      - name: run pr link post message
        shell: bash
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          TEST_CHANNEL_ID: ${{ secrets.TEST_CHANNEL_ID }}
          client_id: ${{ secrets.CLIENT_ID }}
          client_secret: ${{ secrets.CLIENT_SECRET }}
          works_client_id: ${{ secrets.WORKS_CLIENT_ID }}
          works_client_secret: ${{ secrets.WORKS_CLIENT_SECRET }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}
          private_key_path: ${{ secrets.PRIVATE_KEY_PATH }}
          bot_secret: ${{ secrets.BOT_SECRET }}
          PYTHON_SCRIPT: |
            import asyncio, os
            from bot.services.core.post_payload import async_post_message

            message = (
              f"{os.getenv('MESSAGE_PREFIX')}\n"
              f"Ï†úÎ™©: {os.getenv('PR_TITLE')}\n"
              f"ÏûëÏÑ±Ïûê: {os.getenv('PR_AUTHOR')}\n"
              f"ÎßÅÌÅ¨: {os.getenv('PR_URL')}"
            )
            asyncio.run(async_post_message(message, os.getenv("TEST_CHANNEL_ID")))
        run: |
          EVENT_ACTION="${{ github.event.action }}"
          TEST_CHANNEL_ID="${{ secrets.TEST_CHANNEL_ID }}"
          if [[ "$ACTION" == "opened" || "$ACTION" == "reopened" ]]; then
            MESSAGE_PREFIX="‚ú® [NEW PULL REQUEST]"
          elif [[ "$ACTION" == "ready_for_review" ]]; then
            MESSAGE_PREFIX="üîç [READY FOR REVIEW]"
          elif [[ "$ACTION" == "closed" ]]; then
            MESSAGE_PREFIX="üìÅ [PR CLOSED]"
          fi
          export MESSAGE_PREFIX
          uv sync --locked
          uv run python -c "$PYTHON_SCRIPT"
