name: Pull Request Created Event

on:
  pull_request:
    types: [opened, reopened, review_requested, ready_for_review, closed]

jobs:
  pull_request_event:
    name: python
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version-file: "pyproject.toml"
      - uses: astral-sh/setup-uv@v7
      - name: run pr link post message
        shell: bash
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          TEST_CHANNEL_ID: ${{ secrets.TEST_CHANNEL_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          WORKS_CLIENT_ID: ${{ secrets.WORKS_CLIENT_ID }}
          WORKS_CLIENT_SECRET: ${{ secrets.WORKS_CLIENT_SECRET }}
          SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
          PRIVATE_KEY_PATH: ${{ secrets.PRIVATE_KEY_PATH }}
          BOT_SECRET: ${{ secrets.BOT_SECRET }}
          PYTHON_SCRIPT: |
            import asyncio, os
            from bot.services.core.post_payload import async_post_message

            message = (
              f"{os.getenv('MESSAGE_PREFIX')}\n"
              f"Ï†úÎ™©: {os.getenv('PR_TITLE')}\n"
              f"ÏûëÏÑ±Ïûê: {os.getenv('PR_AUTHOR')}\n"
              f"ÎßÅÌÅ¨: {os.getenv('PR_URL')}"
            )
            asyncio.run(async_post_message(message, os.getenv("TEST_CHANNEL_ID")))
        run: |
          EVENT_ACTION="${{ github.event.action }}"
          TEST_CHANNEL_ID="${{ secrets.TEST_CHANNEL_ID }}"
          if [[ "$EVENT_ACTION" == "opened" || "$EVENT_ACTION" == "reopened" ]]; then
            MESSAGE_PREFIX="‚ú® [NEW PULL REQUEST]"
          elif [[ "$EVENT_ACTION" == "review_requested" || "$EVENT_ACTION" == "ready_for_review" ]]; then
            MESSAGE_PREFIX="üîç [READY FOR REVIEW]"
          elif [[ "$EVENT_ACTION" == "closed" ]]; then
            MESSAGE_PREFIX="üìÅ [PR CLOSED]"
          fi
          export MESSAGE_PREFIX
          uv sync --locked
          uv run python -c "$PYTHON_SCRIPT"
